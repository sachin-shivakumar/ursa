# URSA ExecutionAgent Example: Monte Carlo Option Convergence (Human-friendly + CI-safe)

This example demonstrates URSA’s **ExecutionAgent** (LangChain + LangGraph) end-to-end:

1. `run_example.py` invokes the agent using `prompt.md`.
2. The agent **generates** `mc_option_convergence.py` (do not hand-edit it).
3. The generated script runs a deterministic Monte Carlo convergence study for a European call,
   benchmarks against **Black–Scholes**, and writes artifacts under an outputs directory.
4. `validate_outputs.py` validates the artifacts and writes `validation.json`.

This copy of the example is designed to be:
- **Human-friendly** on a TTY (Rich status/panels if available)
- **CI-safe** and fully silent when requested (`--quiet` / `URSA_QUIET=1`)

---

## Read-only source tree and “copy-first” workflow

`./exec_example_code/` is treated as **read-only**. To modify/iterate on this example, work in a copy.

Example (from repo root):

    cp -a exec_example_code/examples/execution_agent_monte_carlo ./work_execution_agent_monte_carlo
    cd ./work_execution_agent_monte_carlo

This repository already contains a working copy under:

- `./work_exec_example_code/examples/execution_agent_monte_carlo/`

---

## Prerequisites

- Python 3.11 (or similar)
- `OPENAI_API_KEY` must be set

Optional:
- `rich` for nicer terminal UX (this example treats Rich as **optional**)
- `matplotlib` for plot generation (headless `Agg` backend)

Model selection:
- `URSA_MODEL` (default used by the runner: `openai:gpt-5-mini`)

---

## Rich is optional (fallback behavior)

- If `rich` is importable **and** stdout is a TTY **and** you are not in quiet mode: the scripts use Rich panels/status/progress.
- If `rich` is not installed (ImportError): scripts fall back to plain, minimal output.
- If stdout is **not** a TTY (common in CI): scripts default to **quiet** to avoid control characters.

---

## Outputs directory

All artifacts/logs are written under an outputs directory:

- Default: `./outputs/`
- Override: `--output-dir SOME_DIR`

Core artifacts (required):
- `<output-dir>/results.csv`
- `<output-dir>/report.md`

Conditional artifact:
- `<output-dir>/plot.png` only if `<output-dir>/preflight.json` indicates plotting is enabled.

Diagnostics (typical):
- `<output-dir>/preflight.json`
- `<output-dir>/run.log`
- `<output-dir>/agent_state.json`
- `<output-dir>/agent_response.md`
- `<output-dir>/verify.json`
- `<output-dir>/validation.json`
- `<output-dir>/db/checkpointer.db*`

---

## Recommended human run (interactive)

Run from this example directory:

    python run_example.py
    python validate_outputs.py

After `run_example.py` completes, you can also re-run the generated script directly:

    python mc_option_convergence.py

---

## Quiet / CI run (absolutely no terminal output)

All scripts support quiet mode.

Option A: CLI flag

    python run_example.py --quiet --log-file outputs/run.log
    python mc_option_convergence.py --quiet --log-file outputs/mc.log
    python validate_outputs.py --quiet --log-file outputs/validate.log

Option B: environment variable

    URSA_QUIET=1 python run_example.py --log-file outputs/run.log
    URSA_QUIET=1 python validate_outputs.py --log-file outputs/validate.log

Notes:
- In quiet mode, **nothing** should be printed to stdout/stderr.
- Use `--log-file` to capture details.

---

## Editing the generated script (don’t) vs. editing the prompt (do)

`mc_option_convergence.py` is **generated by the agent**. Do not hand-edit it.

To change what gets generated (including UX/logging behavior), edit:
- `prompt.md`

---

## End-to-end verification (idempotent, quiet, log-capturing)

This example includes an E2E runner that enforces the “quiet means quiet” rule and runs twice
in the same outputs directory to check idempotency.

Run:

    python e2e_test.py

Verified E2E run (this workspace):
- Command: `python e2e_test.py`
- Observed: exit code 0 and `e2e_summary.json` contains `"ok": true`.

Artifacts/logs produced by the E2E runner:
- `outputs_e2e_rich/e2e_logs/*.stdouterr.json` (captured stdout/stderr per command)
- `outputs_e2e_rich/e2e_summary.json` (per-mode summary)
- `e2e_summary.json` (top-level summary)

Optional: simulate `rich` missing to test fallback behavior:

    python e2e_test.py --include-no-rich

---

## Troubleshooting

If a run fails, inspect (under the selected output dir):
- `run_error.json` (runner exception details)
- `run.log` / `mc.log` / `validate.log`
- `agent_state.json` and `agent_response.md`
- `validation.json`

If you are running in CI/non-TTY and want to see output, do **not** use `--quiet` and ensure a TTY.
